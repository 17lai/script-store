#!/bin/bash
#=============================================================
# https://github.com/cgkings/script-store
# File Name:
# Author: cgkings
# Created Time : 2020.12.25
# Description:
# System Required: Debian/Ubuntu
# Version: 1.0
#=============================================================

curr_date=$(date "+%Y-%m-%d %H:%M:%S")
setcolor

################## 字体格式设置 ##################
setcolor() {
  black=$(tput setaf 0)
  red=$(tput setaf 1)
  green=$(tput setaf 2)
  yellow=$(tput setaf 3)
  bold=$(tput bold)
  jiacu=${normal}${bold}
  blue=$(tput setaf 4)
  magenta=$(tput setaf 5)
  cyan=$(tput setaf 6)
  white=$(tput setaf 7)
  normal=$(tput sgr0)
  on_black=$(tput setab 0)
  on_red=$(tput setab 1)
  on_green=$(tput setab 2)
  on_yellow=$(tput setab 3)
  on_blue=$(tput setab 4)
  on_magenta=$(tput setab 5)
  on_cyan=$(tput setab 6)
  on_white=$(tput setab 7)
  shanshuo=$(tput blink)
  wuguangbiao=$(tput civis)
  guangbiao=$(tput cnorm)
  underline=$(tput smul)
  reset_underline=$(tput rmul)
  dim=$(tput dim)
  standout=$(tput smso)
  reset_standout=$(tput rmso)
  title=${standout}
  baihuangse=${white}${on_yellow}
  bailanse=${white}${on_blue}
  bailvse=${white}${on_green}
  baiqingse=${white}${on_cyan}
  baihongse=${white}${on_red}
  baizise=${white}${on_magenta}
  heibaise=${black}${on_white}
  heihuangse=${on_yellow}${black}
}

################## 检查root权限 ##################
check_root() {
  if [[ $EUID -ne 0 ]]; then
    echo -e "${red}Error:本脚本必须root账号运行，请切换root用户后再执行本脚本!${normal}"
    exit 1
  fi
}

################## 检查VPS架构 ##################
check_vz() {
  if [[ -d "/proc/vz" ]]; then
    echo -e "${red}Error:您的VPS是openVZ架构，臣妾办不到啊!${normal}"
    exit 1
  fi
}

################## 检查fuse安装情况 ##################
check_fuse() {
  if [ ! -f /etc/fuse.conf ]; then
    echo -e "$curr_date 未找到fuse包.正在安装..."
    sleep 1s
    apt-get install fuse -y
    #if [[ "${release}" = "centos" ]];then
    #yum install fuse -y
    #elif [[ "${release}" = "debian" || "${release}" = "ubuntu" ]];then
    #apt-get install fuse -y
    #fi
    echo
    echo -e "$curr_date fuse安装完成"
    echo
  fi
}
################## 检查rclone&fclone安装情况 ##################
check_rclone() {
  bash <(curl -L -s https://rclone.org/install.sh)
  if [ ! -f /usr/bin/fclone ]; then
    wget -qN https://github.com/cgkings/script-store/raw/master/tools/fclone-v0.4.1-linux-amd64.zip && unzip -qo fclone-v0.4.1-linux-amd64.zip -d /usr/bin/ && rm -f fclone-v0.4.1-linux-amd64.zip && chmod +x /usr/bin/fclone && fclone version
  fi
}

################## 检查安装情况 ##################
check_release() {
  if [[ -f /etc/redhat-release ]]; then
    release='centos'
  elif cat /etc/issue | grep -q -E -i "debian"; then
    release='debian'
  elif cat /etc/issue | grep -q -E -i "armbian"; then
    release='armdebian'
  elif cat /etc/issue | grep -q -E -i "ubuntu"; then
    release='ubuntu'
  elif cat /etc/issue | grep -q -E -i "redhat|red hat|centos"; then
    release='centos'
  elif cat /proc/version | grep -q -E -i "debian"; then
    release='debian'
  elif cat /proc/version | grep -q -E -i "ubuntu"; then
    release='ubuntu'
  elif cat /proc/version | grep -q -E -i "redhat|red hat|centos"; then
    release='centos'
  fi
  sys=$(uname -m)
}

check_command() {
  check_release
  for command_arges in $*
  do
  command_status=$(dpkg --get-selections | grep $command_arges)
  if [ -z $command_status ]; then
    echo -e "$(curr_date) ${red}$command_arges${normal} 不存在.正在为您安装，请稍后..."
    if [[ "${release}" = "centos" ]]; then
      yum install $command_arges -y
    elif [[ "${release}" = "debian" || "${release}" = "ubuntu" || "${release}" = "armdebian"  ]]; then
      apt-get update --fix-missing -y && apt upgrade -y
      apt-get install $1command_arges -y
    else
      echo -e "$(curr_date) ${red}对不起！您的系统暂不支持该脚本，请联系作者做定制优化，谢谢！${normal}"
      exit 1
    fi
  fi
  done
}

################## 检查目录情况 ##################
check_dir_file(){
  if [ "${1:0-1:1}" = "/" ] && [ -d "$1" ];then
    return 0
  elif [ -f "$1" ];then
    return 0
  fi
  return 1
}